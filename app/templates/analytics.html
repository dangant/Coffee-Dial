{% extends "base.html" %}
{% block title %}Analytics - Coffee Data{% endblock %}
{% block content %}
<div class="page-header">
    <h1>Analytics</h1>
</div>

<div class="stat-grid">
    <div class="stat-card">
        <div class="value">{{ summary.total_brews }}</div>
        <div class="label">Total Brews</div>
    </div>
    <div class="stat-card">
        <div class="value">{{ summary.average_score or "—" }}</div>
        <div class="label">Avg Score</div>
    </div>
    <div class="stat-card">
        <div class="value">{{ summary.top_roaster or "—" }}</div>
        <div class="label">Top Roaster</div>
    </div>
    {% if summary.highest_rated_bean %}
    <div class="stat-card">
        <div class="value">{{ summary.highest_rated_bean.name }}</div>
        <div class="label">Highest Rated ({{ summary.highest_rated_bean.avg_score }})</div>
    </div>
    {% endif %}
</div>

<div class="chart-grid">
    <div class="card">
        <h2>Score Trends</h2>
        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
            <div class="form-group" style="flex: 1; margin: 0; min-width: 100px;">
                <label>Group By</label>
                <select id="trend-group" onchange="loadTrends()">
                    <option value="day">Daily</option>
                    <option value="week">Weekly</option>
                    <option value="month">Monthly</option>
                </select>
            </div>
            <div class="form-group" style="flex: 1; margin: 0; min-width: 120px;">
                <label>Bean</label>
                <select id="trend-bean" onchange="loadTrends()">
                    <option value="">All</option>
                </select>
            </div>
            <div class="form-group" style="flex: 1; margin: 0; min-width: 120px;">
                <label>Grinder</label>
                <select id="trend-grinder" onchange="loadTrends()">
                    <option value="">All</option>
                </select>
            </div>
            <div class="form-group" style="flex: 1; margin: 0; min-width: 120px;">
                <label>Method</label>
                <div class="temp-toggle" id="trend-method-toggle">
                    <button type="button" data-method="Pour Over" class="active" onclick="setTrendMethod(this)">Pour Over</button>
                    <button type="button" data-method="Espresso" onclick="setTrendMethod(this)">Espresso</button>
                </div>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="trendsChart"></canvas>
        </div>
    </div>

    <div class="card">
        <h2>Brew Method Distribution</h2>
        <div class="chart-container">
            <canvas id="distributionChart"></canvas>
        </div>
    </div>

    <div class="card">
        <h2>Correlations</h2>
        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
            <div class="form-group" style="flex: 1; margin: 0; min-width: 120px;">
                <label>X Axis</label>
                <select id="corr-x" onchange="loadCorrelations()">
                    <option value="grind_setting">Grind Setting</option>
                    <option value="days_since_roast">Days Since Roast</option>
                    <option value="bean_amount_grams">Bean Amount</option>
                    <option value="water_amount_ml">Water Amount</option>
                    <option value="water_temp_f">Water Temp (°F)</option>
                    <option value="brew_time_seconds">Brew Time</option>
                </select>
            </div>
            <div class="form-group" style="flex: 1; margin: 0; min-width: 120px;">
                <label>Y Axis</label>
                <select id="corr-y" onchange="loadCorrelations()">
                    <option value="overall_score">Overall Score</option>
                    <option value="bitterness">Bitterness</option>
                    <option value="acidity">Acidity</option>
                    <option value="sweetness">Sweetness</option>
                    <option value="body">Body</option>
                </select>
            </div>
            <div class="form-group" style="flex: 1; margin: 0; min-width: 120px;">
                <label>Bean</label>
                <select id="corr-bean" onchange="loadCorrelations()">
                    <option value="">All</option>
                </select>
            </div>
            <div class="form-group" style="flex: 1; margin: 0; min-width: 120px;">
                <label>Grinder</label>
                <select id="corr-grinder" onchange="loadCorrelations()">
                    <option value="">All</option>
                </select>
            </div>
            <div class="form-group" style="flex: 1; margin: 0; min-width: 120px;">
                <label>Method</label>
                <select id="corr-method" onchange="loadCorrelations()">
                    <option value="">All</option>
                </select>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="correlationChart"></canvas>
        </div>
    </div>

    <div class="card">
        <h2>Roaster Distribution</h2>
        <div class="chart-container">
            <canvas id="roasterChart"></canvas>
        </div>
    </div>

    <div class="card" style="grid-column: 1 / -1;">
        <h2>Bean Inventory: Pour Over vs Espresso Trade-off</h2>
        <p style="color: var(--text-muted, #888); margin-bottom: 1rem; font-size: 0.9rem;">
            Linear programming optimal allocation — Pour Over uses <strong>25g</strong>, Espresso uses <strong>18g</strong> per cup.
        </p>
        <div class="form-group" style="max-width:260px; margin-bottom:1rem;">
            <label>Bean</label>
            <select id="lp-bean-filter" onchange="loadLP()">
                <option value="">All Beans</option>
            </select>
        </div>
        <div id="lp-summary" style="display:flex; gap:1rem; flex-wrap:wrap; margin-bottom:1rem;"></div>
        <div class="chart-container">
            <canvas id="lpChart"></canvas>
        </div>
        <div id="lp-recommendation" style="margin-top:1rem; padding:0.75rem 1rem; background:rgba(107,68,35,0.08); border-left:3px solid #6b4423; border-radius:4px; font-size:0.9rem;"></div>
        <div id="lp-breakdown" style="margin-top:1rem;"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/chart.umd.min.js"></script>
<script>
const COLORS = [
    '#6b4423', '#d4a574', '#8b5e3c', '#a67c52', '#c49a6c',
    '#4a2c0f', '#e6c9a8', '#9e7b5b', '#b8860b', '#deb887'
];

let trendsChart, distChart, corrChart, roasterChart;

async function loadTrends() {
    const groupBy = document.getElementById('trend-group').value;
    const params = new URLSearchParams({ group_by: groupBy });
    const bean = document.getElementById('trend-bean')?.value;
    const grinder = document.getElementById('trend-grinder')?.value;
    const methodBtn = document.querySelector('#trend-method-toggle button.active');
    const method = methodBtn ? methodBtn.dataset.method : 'Pour Over';
    if (bean) params.set('bean_name', bean);
    if (grinder) params.set('grinder', grinder);
    params.set('brew_method', method);
    const resp = await fetch(`/api/v1/analytics/trends?${params}`);
    const data = await resp.json();
    if (trendsChart) trendsChart.destroy();
    trendsChart = new Chart(document.getElementById('trendsChart'), {
        type: 'line',
        data: {
            labels: data.map(d => d.period),
            datasets: [{
                label: 'Avg Score',
                data: data.map(d => d.avg_score),
                borderColor: '#6b4423',
                backgroundColor: 'rgba(107,68,35,0.1)',
                fill: true,
                tension: 0.3,
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 0, max: 10 } } }
    });
}

function setTrendMethod(btn) {
    document.querySelectorAll('#trend-method-toggle button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    loadTrends();
}

async function loadDistribution() {
    const resp = await fetch('/api/v1/analytics/distributions?field=brew_method');
    const data = await resp.json();
    if (distChart) distChart.destroy();
    distChart = new Chart(document.getElementById('distributionChart'), {
        type: 'doughnut',
        data: {
            labels: data.map(d => d.label),
            datasets: [{ data: data.map(d => d.count), backgroundColor: COLORS }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

function populateSelect(selectEl, items) {
    items.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        selectEl.appendChild(opt);
    });
}

async function loadFilterOptions() {
    try {
        const resp = await fetch('/api/v1/analytics/filter-options');
        const data = await resp.json();
        populateSelect(document.getElementById('corr-bean'), data.bean_names);
        populateSelect(document.getElementById('corr-grinder'), data.grinders);
        populateSelect(document.getElementById('corr-method'), data.brew_methods);
        populateSelect(document.getElementById('trend-bean'), data.bean_names);
        populateSelect(document.getElementById('trend-grinder'), data.grinders);
    } catch (e) {
        console.error('Failed to load filter options:', e);
    }
}

async function loadCorrelations() {
    try {
        const x = document.getElementById('corr-x').value;
        const y = document.getElementById('corr-y').value;
        const bean = document.getElementById('corr-bean').value;
        const grinder = document.getElementById('corr-grinder').value;
        const method = document.getElementById('corr-method').value;
        let url = `/api/v1/analytics/correlations?x=${x}&y=${y}`;
        if (bean) url += `&bean_name=${encodeURIComponent(bean)}`;
        if (grinder) url += `&grinder=${encodeURIComponent(grinder)}`;
        if (method) url += `&brew_method=${encodeURIComponent(method)}`;
        const resp = await fetch(url);
        if (!resp.ok) { console.error('Correlation fetch failed:', resp.status); return; }
        const data = await resp.json();
        if (corrChart) corrChart.destroy();
        const xLabel = document.getElementById('corr-x').selectedOptions[0].text;
        const yLabel = document.getElementById('corr-y').selectedOptions[0].text;
        corrChart = new Chart(document.getElementById('correlationChart'), {
            type: 'scatter',
            data: {
                datasets: [{
                    label: `${xLabel} vs ${yLabel}`,
                    data: data.map(d => ({ x: d.x, y: d.y })),
                    backgroundColor: 'rgba(107,68,35,0.6)',
                    pointRadius: 6,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { title: { display: true, text: xLabel } },
                    y: { title: { display: true, text: yLabel } }
                },
                plugins: {
                    legend: { display: true },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `${xLabel}: ${ctx.parsed.x}, ${yLabel}: ${ctx.parsed.y}`
                        }
                    }
                }
            }
        });
    } catch (e) {
        console.error('Failed to load correlations:', e);
    }
}

async function loadRoasterDist() {
    const resp = await fetch('/api/v1/analytics/distributions?field=roaster');
    const data = await resp.json();
    if (roasterChart) roasterChart.destroy();
    roasterChart = new Chart(document.getElementById('roasterChart'), {
        type: 'bar',
        data: {
            labels: data.map(d => d.label),
            datasets: [{ label: 'Brews', data: data.map(d => d.count), backgroundColor: '#6b4423' }]
        },
        options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' }
    });
}

let lpChart;

async function populateLPBeans() {
    const resp = await fetch('/api/v1/shelf/beans');
    const beans = await resp.json();
    const sel = document.getElementById('lp-bean-filter');
    // Remove all options except "All Beans"
    while (sel.options.length > 1) sel.remove(1);
    beans.forEach(b => {
        const opt = document.createElement('option');
        opt.value = b;
        opt.textContent = b;
        sel.appendChild(opt);
    });
}

async function loadLP() {
    const beanFilter = document.getElementById('lp-bean-filter')?.value || '';
    const url = beanFilter ? `/api/v1/shelf/lp?bean_name=${encodeURIComponent(beanFilter)}` : '/api/v1/shelf/lp';
    const resp = await fetch(url);
    const d = await resp.json();
    const label = beanFilter ? `"${beanFilter}"` : 'all tracked beans';

    // Summary chips
    document.getElementById('lp-summary').innerHTML = `
        <div class="stat-card" style="flex:1; min-width:120px; padding:0.5rem 1rem;">
            <div class="value" style="font-size:1.4rem;">${d.total_remaining_grams}g</div>
            <div class="label">Remaining (${beanFilter || 'All'})</div>
        </div>
        <div class="stat-card" style="flex:1; min-width:120px; padding:0.5rem 1rem;">
            <div class="value" style="font-size:1.4rem;">${d.max_pour_overs}</div>
            <div class="label">Max Pour Overs</div>
        </div>
        <div class="stat-card" style="flex:1; min-width:120px; padding:0.5rem 1rem;">
            <div class="value" style="font-size:1.4rem;">${d.max_espressos}</div>
            <div class="label">Max Espressos</div>
        </div>
        <div class="stat-card" style="flex:1; min-width:120px; padding:0.5rem 1rem; border-left:3px solid #6b4423;">
            <div class="value" style="font-size:1.4rem;">${d.optimal_espressos}</div>
            <div class="label">Optimal (Max Cups)</div>
        </div>
    `;

    // Recommendation text
    document.getElementById('lp-recommendation').innerHTML = d.total_remaining_grams > 0
        ? `<strong>Optimal for ${label}:</strong> With <strong>${d.total_remaining_grams}g</strong> remaining,
           make <strong>${d.optimal_espressos} espressos</strong> to maximize total cups,
           or up to <strong>${d.max_pour_overs} pour overs</strong>.
           Any point on the trade-off line is a valid allocation.`
        : `<strong>No inventory tracked${beanFilter ? ` for "${beanFilter}"` : ''}.</strong>
           Visit <a href="/shelf">On the Shelf</a> to enter your bean inventory.`;

    // Per-bean breakdown
    if (d.breakdown && d.breakdown.length) {
        document.getElementById('lp-breakdown').innerHTML = `
            <details>
                <summary style="cursor:pointer; font-weight:600; color:#6b4423;">Bean Breakdown</summary>
                <table class="brew-table" style="margin-top:0.5rem;">
                    <thead><tr><th>Bean</th><th>Roaster</th><th>Remaining</th><th>Max Espressos</th><th>Max Pour Overs</th></tr></thead>
                    <tbody>
                        ${d.breakdown.map(b => `<tr>
                            <td>${b.bean_name}</td>
                            <td>${b.roaster || '—'}</td>
                            <td>${b.remaining_grams != null ? b.remaining_grams + 'g' : '—'}</td>
                            <td>${b.remaining_grams != null ? Math.floor(b.remaining_grams / 18) : '—'}</td>
                            <td>${b.remaining_grams != null ? Math.floor(b.remaining_grams / 25) : '—'}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </details>`;
    } else {
        document.getElementById('lp-breakdown').innerHTML = '';
    }

    if (lpChart) lpChart.destroy();
    if (d.total_remaining_grams <= 0) return;

    const tradeoffLine = d.constraint_line.map(p => ({ x: p.x, y: p.y }));
    const equalX = Math.floor(d.total_remaining_grams / (25 + 18));

    lpChart = new Chart(document.getElementById('lpChart'), {
        type: 'scatter',
        data: {
            datasets: [
                {
                    label: `Trade-off boundary (25x + 18y = ${d.total_remaining_grams}g)`,
                    data: tradeoffLine,
                    type: 'line',
                    borderColor: '#6b4423',
                    backgroundColor: 'rgba(107,68,35,0.08)',
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: 'origin',
                    tension: 0,
                    order: 2,
                },
                {
                    label: `★ Optimal: ${d.optimal_espressos} espressos (max cups)`,
                    data: [{ x: 0, y: d.optimal_espressos }],
                    backgroundColor: '#6b4423',
                    pointRadius: 10,
                    pointStyle: 'star',
                    order: 1,
                },
                {
                    label: `All Pour Over: ${d.max_pour_overs} cups`,
                    data: [{ x: d.max_pour_overs, y: 0 }],
                    backgroundColor: '#d4a574',
                    pointRadius: 8,
                    order: 1,
                },
                {
                    label: `Equal split: ${equalX} each`,
                    data: [{ x: equalX, y: equalX }],
                    backgroundColor: '#8b5e3c',
                    pointRadius: 8,
                    pointStyle: 'rect',
                    order: 1,
                },
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: { display: true, text: 'Pour Overs (cups)' },
                    min: 0,
                    suggestedMax: Math.ceil(d.max_pour_overs * 1.1) + 1,
                },
                y: {
                    title: { display: true, text: 'Espressos (cups)' },
                    min: 0,
                    suggestedMax: Math.ceil(d.max_espressos * 1.1) + 1,
                }
            },
            plugins: {
                legend: { display: true },
                tooltip: {
                    callbacks: {
                        label: (ctx) => {
                            if (ctx.datasetIndex === 0) {
                                return `${ctx.parsed.x.toFixed(0)} pour overs + ${ctx.parsed.y.toFixed(0)} espressos`;
                            }
                            return ctx.dataset.label;
                        }
                    }
                }
            }
        }
    });
}

// Load all on page ready
loadDistribution();
loadRoasterDist();
populateLPBeans().then(() => loadLP());
loadFilterOptions().then(() => { loadTrends(); loadCorrelations(); });
</script>
{% endblock %}
