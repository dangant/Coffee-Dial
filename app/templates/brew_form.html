{% extends "base.html" %}
{% block title %}{{ "Edit Brew" if brew else "New Brew" }} - Coffee Tracker{% endblock %}
{% block content %}
<div class="page-header">
    <h1>{{ "Edit Brew" if brew else "Log New Brew" }}</h1>
</div>

<div class="card">
    {% if templates_list %}
    <div class="form-group" style="margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border);">
        <label>Load from Template</label>
        <select onchange="loadTemplate(this)">
            <option value="">— Select a template —</option>
            {% for tpl in templates_list %}
            <option value="{{ tpl.id }}">{{ tpl.name }}</option>
            {% endfor %}
        </select>
    </div>
    {% endif %}

    <form method="post" action="/brews/new">
        <input type="hidden" name="template_id" value="{{ brew.template_id or '' if brew else '' }}">

        <h3 style="margin-bottom: 1rem; color: var(--primary);">Bean Info</h3>
        <div class="form-grid">
            <div class="form-group">
                <label>Brew Date *</label>
                <input type="date" name="brew_date" value="{{ brew.brew_date if brew else '' }}" required>
            </div>
            <div class="form-group">
                <label>Roaster *</label>
                <input type="text" name="roaster" value="{{ brew.roaster if brew else '' }}" required placeholder="e.g., Onyx Coffee Lab">
            </div>
            <div class="form-group">
                <label>Bean Name *</label>
                <input type="text" name="bean_name" value="{{ brew.bean_name if brew else '' }}" required placeholder="e.g., Sagastume Family Natural">
            </div>
            <div class="form-group">
                <label>Origin</label>
                <input type="text" name="bean_origin" value="{{ brew.bean_origin or '' if brew else '' }}" placeholder="e.g., Honduras">
            </div>
            <div class="form-group">
                <label>Process</label>
                <select name="bean_process">
                    <option value="">—</option>
                    {% for p in ["Washed", "Natural", "Honey", "Anaerobic", "Wet-Hulled", "Other"] %}
                    <option value="{{ p }}" {{ 'selected' if brew and brew.bean_process == p else '' }}>{{ p }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Roast Date</label>
                <input type="date" name="roast_date" value="{{ brew.roast_date if brew and brew.roast_date else '' }}">
            </div>
            <div class="form-group">
                <label>Roast Level</label>
                <select name="roast_level">
                    <option value="">—</option>
                    {% for r in ["Light", "Medium-Light", "Medium", "Medium-Dark", "Dark"] %}
                    <option value="{{ r }}" {{ 'selected' if brew and brew.roast_level == r else '' }}>{{ r }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group full-width">
                <label>Expected Flavor Notes (select up to 4)</label>
                <input type="text" id="flavor-search" placeholder="Search flavors..."
                    oninput="filterFlavorNotes(this.value)"
                    style="margin-bottom: 0.5rem; max-width: 300px;">
                {% set selected_notes = brew.flavor_notes_expected.split(', ') if brew and brew.flavor_notes_expected else [] %}
                <div class="flavor-checkboxes" id="flavor-checkboxes">
                    {% for note in flavor_notes %}
                    <label class="checkbox-pill">
                        <input type="checkbox" name="flavor_notes_expected" value="{{ note.name }}"
                            {{ 'checked' if note.name in selected_notes else '' }}
                            onchange="limitCheckboxes(this, 4)">
                        <span>{{ note.name }}</span>
                    </label>
                    {% endfor %}
                </div>
                <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem; align-items: center;">
                    <input type="text" id="new-flavor-input" placeholder="Add new flavor note..."
                        style="flex: 1;" onkeydown="if(event.key==='Enter'){event.preventDefault();addFlavorNote();}">
                    <button type="button" class="btn btn-outline btn-sm" onclick="addFlavorNote()">Add</button>
                </div>
            </div>
        </div>

        <h3 style="margin: 1.5rem 0 1rem; color: var(--primary);">Brew Parameters</h3>
        <div class="form-grid">
            <div class="form-group">
                <label>Bean Amount (g) *</label>
                <input type="number" step="0.1" name="bean_amount_grams" value="{{ brew.bean_amount_grams if brew else '' }}" required placeholder="e.g., 18">
            </div>
            <div class="form-group">
                <label>Water Amount (ml) *</label>
                <input type="number" step="0.1" name="water_amount_ml" value="{{ brew.water_amount_ml if brew else '' }}" required placeholder="e.g., 300">
            </div>
            <div class="form-group">
                <label>Grind Setting</label>
                <input type="text" name="grind_setting" value="{{ brew.grind_setting or '' if brew else '' }}" placeholder="e.g., 1.3.5 or 24" pattern="[0-9]+(\.[0-9]+)*">
            </div>
            <div class="form-group">
                <label>Grinder</label>
                <select name="grinder">
                    <option value="">—</option>
                    {% for g in grinders %}
                    <option value="{{ g.name }}" {{ 'selected' if brew and brew.grinder == g.name else '' }}>{{ g.name }}</option>
                    {% endfor %}
                </select>
                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; align-items: center;">
                    <input type="text" id="new-grinder-input" placeholder="Or add new grinder..." style="flex: 1;"
                        onkeydown="if(event.key==='Enter'){event.preventDefault();addGrinder();}">
                    <button type="button" class="btn btn-outline btn-sm" onclick="addGrinder()">Add</button>
                </div>
            </div>
            <div class="form-group">
                <label>Brew Method *</label>
                <select name="brew_method" required>
                    <option value="">— Select —</option>
                    {% for m in ["Pour Over", "Espresso", "French Press", "AeroPress", "Moka Pot", "Cold Brew", "Drip", "Siphon", "Other"] %}
                    <option value="{{ m }}" {{ 'selected' if brew and brew.brew_method == m else '' }}>{{ m }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Brew Device</label>
                <select name="brew_device">
                    <option value="">—</option>
                    {% for device in brew_devices %}
                    <option value="{{ device.name }}" {{ 'selected' if brew and brew.brew_device == device.name else '' }}>{{ device.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>
                    Water Temp
                    <span class="temp-toggle" style="margin-left: 0.5rem;">
                        <button type="button" data-unit="F" class="active" onclick="toggleTemp('F')">°F</button>
                        <button type="button" data-unit="C" onclick="toggleTemp('C')">°C</button>
                    </span>
                </label>
                <input type="number" step="0.1" name="water_temp" id="water-temp-input"
                    value="{{ brew.water_temp_f or '' if brew else '' }}"
                    placeholder="e.g., 205">
                <input type="hidden" name="water_temp_unit" id="water-temp-unit" value="F">
            </div>
            <div class="form-group">
                <label>Total Brew Time (seconds)</label>
                <input type="number" name="brew_time_seconds" value="{{ brew.brew_time_seconds or '' if brew else '' }}" placeholder="e.g., 210">
            </div>
            <div class="toggle-group">
                <input type="checkbox" name="bloom" id="bloom-toggle" {{ 'checked' if brew and brew.bloom else '' }}
                    onchange="document.getElementById('bloom-fields').style.display = this.checked ? '' : 'none'">
                <label for="bloom-toggle" style="font-weight: 600;">Bloom</label>
            </div>
        </div>

        <div id="bloom-fields" class="form-grid" style="{{ '' if brew and brew.bloom else 'display: none;' }} margin-top: 1rem;">
            <div class="form-group">
                <label>Bloom Time (seconds)</label>
                <input type="number" name="bloom_time_seconds" value="{{ brew.bloom_time_seconds or '' if brew else '' }}" placeholder="e.g., 30">
            </div>
            <div class="form-group">
                <label>Bloom Water (ml)</label>
                <input type="number" step="0.1" name="bloom_water_ml" value="{{ brew.bloom_water_ml or '' if brew else '' }}" placeholder="e.g., 50">
            </div>
        </div>

        <h3 style="margin: 1.5rem 0 1rem; color: var(--primary);">Additional Details</h3>
        <div class="form-grid">
            <div class="form-group">
                <label>Water Filter</label>
                <input type="text" name="water_filter_type" value="{{ brew.water_filter_type or '' if brew else '' }}" placeholder="e.g., Brita, Third Wave Water">
            </div>
            <div class="form-group">
                <label>Altitude (ft)</label>
                <input type="number" name="altitude_ft" value="{{ brew.altitude_ft or '' if brew else '' }}" placeholder="e.g., 5280">
            </div>
            <div class="form-group full-width">
                <label>Notes</label>
                <textarea name="notes" placeholder="Any observations about the brew...">{{ brew.notes or '' if brew else '' }}</textarea>
            </div>
        </div>

        <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
            <button type="submit" class="btn btn-primary">Save Brew</button>
            <a href="/brews" class="btn btn-outline">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}
